---
title: 《CLRViaC#》第7章 常量和字段
date: 2022-02-21 17:40:30
tags: [ C#, CLR]
categories: [ C#]
about:
description: "阅读笔记与总结，这本书的深度远高于我的理解范畴，因而笔记不免有所遗漏，如果有缺漏之处请查看原书。"
---

## 7.1 常量

常量是值从不变化的符号，定义常量符号时，他的值必须能在编译阶段确认，确认之后编译器将常量值保存到程序集元数据中。这意味着只能定义基元类型的常量。除此之外，C#还允许将非基元类型的常量定义为null。

``` csharp
using System;
public sealed class SomeType
{
    public const SomeType Empty = null;
}
```

常量从不变化，所以常量总是被视为类型定义的一部分。因而常量总是被是视为静态的。常量的值将会直接嵌入代码，因而操作其地址，也不能通过操作常量的引用。同时，因为常量已经是静态，所以无法为其添加static修饰。

如果希望在运行时从一个程序集中提取另一个程序集中的值，那么不应该使用常量，而应该使用readonly字段。

## 7.2 字段

引用了该类型的任何方法进行JIT编译时会将其加载到AppDomain之中，之后会将其实例化，分配内存。

| CLR术语  | C#术语   | 说明                                                         |
| -------- | -------- | ------------------------------------------------------------ |
| Static   | static   | 这种字段是类型字段的一部分，而不是对象状态的一部分           |
| Instance | 默认     | 这种字段与类型的一个实例关联，而不是与类型本身关联           |
| InitOnly | readonly | 这种字段只能由一个构造器方法中的代码写入                     |
| Volarile | volatile | 编译器、CLR和硬件不会对访问这种字段的代码执行“线程不安全”的优化措施。详见29章。 |

CLR支持readonly字段和read/write字段。大多数字段都是read/write字段，意味着在代码执行过程中，字段值可以发生多次改变。反射可以用来修改readonly字段。

当某个字段是引用类型，并且该字段被标记为readonly时，不可改变的是引用而非字段引用的对象。
